<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="vcr">
<title>Design of vcr • vcr</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Design of vcr">
<meta property="og:description" content="vcr">
<meta property="og:image" content="https://docs.ropensci.org/vcr/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">vcr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.2.2.93</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../articles/vcr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/vcr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Design of vcr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/vcr/blob/HEAD/vignettes/design.Rmd" class="external-link"><code>vignettes/design.Rmd</code></a></small>
      <div class="d-none name"><code>design.Rmd</code></div>
    </div>

    
    
<p>This section explains <code>vcr</code>’s internal design and architecture.</p>
<div class="section level3">
<h3 id="where-vcr-comes-from-and-why-r6">Where vcr comes from and why R6<a class="anchor" aria-label="anchor" href="#where-vcr-comes-from-and-why-r6"></a>
</h3>
<p><code>vcr</code> was “ported” from the Ruby gem (aka, library) of the same name<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The first version of Ruby’s vcr was released in February 2010 &lt;a href="https://rubygems.org/gems/vcr/versions/0.1.0" class="external-link uri"&gt;https://rubygems.org/gems/vcr/versions/0.1.0&lt;/a&gt;. Ruby vcr source code: &lt;a href="https://github.com/vcr/vcr/" class="external-link uri"&gt;https://github.com/vcr/vcr/&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>. Because it was ported from Ruby, an object-oriented programming language I thought it would be easier to use an object system in R that most closely resemble that used in Ruby (at least in my opinion). This thinking lead to choosing <a href="https://adv-r.hadley.nz/r6.html" class="external-link">R6</a>. The exported functions users interact with are not R6 classes, but are rather normal R functions. However, most of the internal code in the package uses R6. Thus, familiarity with R6 is important for people that may want to contribute to <code>vcr</code>, but not required at all for <code>vcr</code> users.</p>
</div>
<div class="section level3">
<h3 id="principles">Principles<a class="anchor" aria-label="anchor" href="#principles"></a>
</h3>
<div class="section level4">
<h4 id="an-easy-to-use-interface-hides-complexity">An easy to use interface hides complexity<a class="anchor" aria-label="anchor" href="#an-easy-to-use-interface-hides-complexity"></a>
</h4>
<p>As described above, <code>vcr</code> uses R6 internally, but users interact with normal R functions. Internal functions that are quite complicated are largely R6 while exported, simpler functions users interact with are normal R functions.</p>
</div>
<div class="section level4">
<h4 id="classfunction-names-are-inherited-from-ruby-vcr">Class/function names are inherited from Ruby vcr<a class="anchor" aria-label="anchor" href="#classfunction-names-are-inherited-from-ruby-vcr"></a>
</h4>
<p>Since R <code>vcr</code> was ported from Ruby, we kept most of the names of functions/classes and variables. So if you’re wondering about why a function, class, or variable has a particular name, its derivation can not be found out in this package, for the most part that is.</p>
</div>
<div class="section level4">
<h4 id="hooks-into-http-clients">Hooks into HTTP clients<a class="anchor" aria-label="anchor" href="#hooks-into-http-clients"></a>
</h4>
<p>Perhaps the most fundamental thing about that this package work is how it knows what HTTP requests are being made. This stumped me for quite a long time. When looking at Ruby vcr, at first I thought it must be “listening” for HTTP requests somehow. Then I found out about <a href="https://en.wikipedia.org/wiki/Monkey_patch" class="external-link">monkey patching</a>; that’s how it’s achieved in Ruby. That is, the Ruby vcr package literally overrides certain methods in Ruby HTTP clients, hijacking internals of the HTTP clients.</p>
<p>However, monkey patching is not allowed in R. Thus, in R we have to somehow have “hooks” into HTTP clients in R. Fortunately, Scott is the maintainer of one of the HTTP clients, <code>crul</code>, so was able to quickly create a hook. Very fortunately, there was already a hook mechanism in the <code>httr</code> package.</p>
<p>The actual hooks are not in <code>vcr</code>, but in <code>webmockr</code>. <code>vcr</code> depends on <code>webmockr</code> for hooking into HTTP clients <code>httr</code> and <code>crul</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="internal-classes">Internal classes<a class="anchor" aria-label="anchor" href="#internal-classes"></a>
</h3>
<p>An overview of some of the more important aspects of vcr.</p>
<div class="section level4">
<h4 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h4>
<p>An internal object (<code>vcr_c</code>) is created when <code>vcr</code> is loaded with the default vcr configuration options inside of an R6 class <code>VCRConfig</code> - see <a href="https://github.com/ropensci/vcr/blob/main/R/onLoad.R" class="external-link uri">https://github.com/ropensci/vcr/blob/main/R/onLoad.R</a>. This class is keeps track of default and user specified configuration options. You can access <code>vcr_c</code> using triple namespace <code>:::</code>, though it is not intended for general use. Whenever you make calls to <code><a href="../reference/vcr_configure.html">vcr_configure()</a></code> or other configuration functions, <code>vcr_c</code> is affected.</p>
</div>
<div class="section level4">
<h4 id="cassette-class">Cassette class<a class="anchor" aria-label="anchor" href="#cassette-class"></a>
</h4>
<p><code>Cassette</code> is an R6 class that handles internals/state for each cassette. Each time you run <code><a href="../reference/use_cassette.html">use_cassette()</a></code> this class is used. The class has quite a few methods in it, so there’s a lot going on in the class. Ideally the class would be separated into subclasses to handle similar sets of logic, but there’s not an easy way to do that with R6.</p>
<p>Of note in <code>Cassette</code> is that when called, within the <code>initialize()</code> call <code>webmockr</code> is used to create webmockr stubs.</p>
</div>
<div class="section level4">
<h4 id="how-http-requests-are-handled">How HTTP requests are handled<a class="anchor" aria-label="anchor" href="#how-http-requests-are-handled"></a>
</h4>
<p>Within <code>webmockr</code>, there are calls to the vcr class <code>RequestHandler</code>, which has child classes <code>RequestHandlerCrul</code> and <code>RequestHandlerHttr</code> for <code>crul</code> and <code>httr</code>, respectively. These classes determine what to do with each HTTP request. The options for each HTTP request include:</p>
<ul>
<li>
<strong>Ignored</strong> You can ignore HTTP requests under certain rules using the configuration options <code>ignore_hosts</code> and <code>ignore_localhost</code>
</li>
<li>
<strong>Stubbed by vcr</strong> This is an HTTP request for which a match is found in the cassette defined in the <code><a href="../reference/use_cassette.html">use_cassette()</a></code>/<code><a href="../reference/insert_cassette.html">insert_cassette()</a></code> call. In this case the matching request/response from the cassette is returned with no real HTTP request allowed.</li>
<li>
<strong>Recordable</strong> This is an HTTP request for which no match is found in the cassette defined in the <code><a href="../reference/use_cassette.html">use_cassette()</a></code>/<code><a href="../reference/insert_cassette.html">insert_cassette()</a></code> call. In this case a real HTTP request is allowed, and the request/response is recorded to the cassette.</li>
<li>
<strong>Unhandled</strong> This is a group of cases, all of which cause an error to be thrown with a message trying to help the user figure out how to fix the problem.</li>
</ul>
<p>If you use <a href="https://docs.ropensci.org/vcr/articles/debugging.html?q=logging#logging-1">vcr logging</a> you’ll see these categories in your logs.</p>
</div>
<div class="section level4">
<h4 id="serializers">Serializers<a class="anchor" aria-label="anchor" href="#serializers"></a>
</h4>
<p>Serializers handle in what format cassettes are written to files on disk. The current options are YAML (default) and JSON. YAML was implemented first in <code>vcr</code> because that’s the default option in Ruby vcr.</p>
<p>An R6 class <code>Serializer</code> is the parent class for all serializer types; <code>YAML</code> and <code>JSON</code> are both R6 classes that inherit from <code>Serializer</code>. Both <code>YAML</code> and <code>JSON</code> define just two methods: <code><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize()</a></code> and <code>deserialize()</code> for converting R structures to yaml or json, and converting yaml or json back to R structures, respectively.</p>
</div>
</div>
<div class="section level3">
<h3 id="environments">Environments<a class="anchor" aria-label="anchor" href="#environments"></a>
</h3>
<div class="section level4">
<h4 id="logging">Logging<a class="anchor" aria-label="anchor" href="#logging"></a>
</h4>
<p>An internal environment (<code>vcr_log_env</code>) is used when you use logging. At this point it only keeps track of one variable - <code>file</code> - to be able to refer to what file is used for logging across many classes/functions that need to write to the log file.</p>
</div>
<div class="section level4">
<h4 id="a-bit-of-housekeeping">A bit of housekeeping<a class="anchor" aria-label="anchor" href="#a-bit-of-housekeeping"></a>
</h4>
<p>Another internal environment (<code>vcr__env</code>) is used to keep track of a few items, including the current cassette in use, and the last vcr error.</p>
</div>
<div class="section level4">
<h4 id="lightswitch">Lightswitch<a class="anchor" aria-label="anchor" href="#lightswitch"></a>
</h4>
<p>Another internal environment (<code>light_switch</code>) is used to keep track of users turning on and off <code>vcr</code>. See <code><a href="../reference/lightswitch.html">?lightswitch</a></code>.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
